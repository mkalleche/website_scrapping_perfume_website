/**
 * Generate CREATE TABLE SQL from Prisma schema
 * This creates SQL that can be run in Supabase SQL Editor
 */

const fs = require('fs');
const path = require('path');

const schemaPath = path.join(__dirname, '../prisma/schema.prisma');
const outputPath = path.join(__dirname, '../CREATE_ALL_TABLES.sql');

console.log('üìù Generating CREATE TABLE SQL from Prisma schema...\n');

// Read Prisma schema
const schema = fs.readFileSync(schemaPath, 'utf8');

// Extract enum types
const enumRegex = /enum\s+(\w+)\s*\{([^}]+)\}/g;
const enums = [];
let enumMatch;
while ((enumMatch = enumRegex.exec(schema)) !== null) {
  const enumName = enumMatch[1];
  const enumValues = enumMatch[2]
    .split('\n')
    .map(line => line.trim())
    .filter(line => line && !line.startsWith('//'))
    .map(line => line.replace(/,$/, '').replace(/"/g, "'"));
  enums.push({ name: enumName, values: enumValues });
}

// Generate SQL
let sql = `-- ============================================
-- SQL Generated from Prisma Schema
-- Run this in Supabase SQL Editor: https://supabase.com/dashboard/project/otwwbtndkwkzgjqozcfn/sql/new
-- ============================================

-- Create Enum Types
`;

// Create enum types
enums.forEach(enumType => {
  sql += `CREATE TYPE public."${enumType.name}" AS ENUM (${enumType.values.map(v => `'${v}'`).join(', ')});\n`;
});

sql += `\n-- ============================================
-- IMPORTANT: The table creation SQL needs to be generated by Prisma
-- ============================================
-- To create tables, you have two options:
--
-- OPTION 1: Fix IP allowlist and use Prisma (Recommended)
-- 1. Go to: https://supabase.com/dashboard/project/otwwbtndkwkzgjqozcfn
-- 2. Settings ‚Üí Database ‚Üí Connection Pooling
-- 3. Add your IP address (or allow all: 0.0.0.0/0)
-- 4. Run: npx prisma db push --skip-generate
--
-- OPTION 2: Use Supabase SQL Editor
-- 1. Go to: https://supabase.com/dashboard/project/otwwbtndkwkzgjqozcfn/sql/new
-- 2. Try running: npx prisma migrate dev --create-only --name init
-- 3. If that works, find SQL in: prisma/migrations/[timestamp]_init/migration.sql
-- 4. Copy and run that SQL in Supabase SQL Editor
--
-- ============================================
-- After creating tables, restore your data:
-- ============================================
-- 1. Open: database_dump_public_only.sql
-- 2. Copy INSERT statements
-- 3. Run in Supabase SQL Editor
`;

fs.writeFileSync(outputPath, sql);

console.log('‚úÖ SQL file generated!');
console.log(`üìÅ Location: ${outputPath}`);
console.log('\nüí° Next steps:');
console.log('   1. Add your IP to Supabase allowlist');
console.log('   2. Run: npx prisma db push --skip-generate');
console.log('   3. Or use the SQL file above in Supabase SQL Editor');



